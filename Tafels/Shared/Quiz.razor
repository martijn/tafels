@using BlafettisLib
@foreach (var sum in Round.Sums)
{
    @if (sum == Round.Sums.FirstOrDefault(s => !s.Correct))
    {
        <QuizSum @key="sum" Sum="@sum" onchange="@SumChange" ShowResult="@Round.ShowResults" @ref="_firstSum"/>
    }
    else
    {
        <QuizSum @key="sum" Sum="@sum" onchange="@SumChange" ShowResult="@Round.ShowResults"/>
    }
}

<Blafettis @ref="Blafettis" angle="70"/>

@if (Round.ShowResults)
{
    @if (Round.Completed)
    {
        @ChildContent
    }
    else
    {
        <p class="notification">Bijna goed, verbeter je fouten om door te gaan!</p>
        <button class="button is-large is-link" @onclick="Check">Controleren</button>
    }
}
else
{
    <button class="button is-large is-link" @onclick="Check">Controleren</button>
}

@code {

    [Parameter]
    public EventCallback Check { get; set; }

    [Parameter]
    public Round Round { get; set; }

    [Parameter]
    public RenderFragment ChildContent { get; set; }

    private bool _confettiFired = false;

    private Blafettis Blafettis;
    private QuizSum _firstSum;

    private async Task SumChange()
    {
        // If user is correcting mistakes, show feedback immediately
        if (Round.ShowResults) await Check.InvokeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !Round.Completed && _firstSum is not null)
            await _firstSum.Focus();

        if (Round.ShowResults && !Round.Completed)
            Round.MistakesWereMade = true; // TODO Lift into class?

        if (Round.ShowResults && Round.Completed && !Round.MistakesWereMade && !_confettiFired)
        {
            _confettiFired = true;
            Blafettis.RaiseConfetti();
        }
    }

}